name: Bee-Quorum Merge Guard

on:
  pull_request:
    types: [opened, synchronize, labeled, unlabeled]
  pull_request_review:
    types: [submitted]

jobs:
  score-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      checks: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        id: tests
        run: |
          pnpm test 2>&1 | tee test-output.txt
          TEST_PASSED=$?
          TEST_TOTAL=$(grep -c "✓\|✗" test-output.txt || echo "0")
          TEST_PASSED_COUNT=$(grep -c "✓" test-output.txt || echo "0")
          echo "passed=$TEST_PASSED_COUNT" >> $GITHUB_OUTPUT
          echo "total=$TEST_TOTAL" >> $GITHUB_OUTPUT
          exit $TEST_PASSED

      - name: Check coverage
        id: coverage
        run: |
          pnpm test:coverage 2>&1 | tee coverage-output.txt || true
          COVERAGE=$(grep -oP 'Lines\s+:\s+\K[\d.]+' coverage-output.txt | head -1 || echo "0")
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

      - name: Run linter
        id: lint
        run: |
          pnpm lint 2>&1 | tee lint-output.txt || true
          LINT_ERRORS=$(grep -c "error" lint-output.txt || echo "0")
          LINT_WARNINGS=$(grep -c "warning" lint-output.txt || echo "0")
          echo "errors=$LINT_ERRORS" >> $GITHUB_OUTPUT
          echo "warnings=$LINT_WARNINGS" >> $GITHUB_OUTPUT

      - name: Check performance
        id: perf
        run: |
          # Run performance tests if available
          pnpm test:perf 2>&1 | tee perf-output.txt || true
          PERF_SCORE=100
          echo "score=$PERF_SCORE" >> $GITHUB_OUTPUT

      - name: Calculate PR Score
        id: score
        run: |
          TEST_SCORE=$(( ${{ steps.tests.outputs.passed }} * 100 / (${{ steps.tests.outputs.total }} + 1) ))
          COVERAGE_SCORE=${{ steps.coverage.outputs.coverage }}
          LINT_ERRORS=${{ steps.lint.outputs.errors }}
          LINT_SCORE=$(( 100 - LINT_ERRORS * 10 ))
          PERF_SCORE=${{ steps.perf.outputs.score }}
          
          TOTAL_SCORE=$(( TEST_SCORE * 40 / 100 + COVERAGE_SCORE * 30 / 100 + LINT_SCORE * 20 / 100 + PERF_SCORE * 10 / 100 ))
          
          echo "test_score=$TEST_SCORE" >> $GITHUB_OUTPUT
          echo "coverage_score=$COVERAGE_SCORE" >> $GITHUB_OUTPUT
          echo "lint_score=$LINT_SCORE" >> $GITHUB_OUTPUT
          echo "perf_score=$PERF_SCORE" >> $GITHUB_OUTPUT
          echo "total_score=$TOTAL_SCORE" >> $GITHUB_OUTPUT

      - name: Add DANCE label
        uses: actions/github-script@v7
        with:
          script: |
            const score = ${{ steps.score.outputs.total_score }};
            const danceLabel = `DANCE:${score}`;
            
            // Remove old DANCE labels
            const labels = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const oldDanceLabels = labels.data.filter(l => l.name.startsWith('DANCE:'));
            for (const label of oldDanceLabels) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: label.name,
              });
            }
            
            // Add new DANCE label
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: [danceLabel],
              });
            } catch (error) {
              // Label might not exist, create it
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: danceLabel,
                color: '0e8a16',
              });
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: [danceLabel],
              });
            }

      - name: Check Quorum
        id: quorum
        uses: actions/github-script@v7
        with:
          script: |
            const labels = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // Sum DANCE labels
            const danceLabels = labels.data.filter(l => l.name.startsWith('DANCE:'));
            const danceSum = danceLabels.reduce((sum, label) => {
              const value = parseInt(label.name.split(':')[1]) || 0;
              return sum + value;
            }, 0);
            
            // Check for safety veto
            const safetyVeto = labels.data.some(l => l.name === 'SAFETY:BLOCK' || l.name === 'SAFETY:VETO');
            
            // Count approvals
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const approvals = reviews.data.filter(r => r.state === 'APPROVED').length;
            const rejections = reviews.data.filter(r => r.state === 'CHANGES_REQUESTED').length;
            
            const QUORUM_THRESHOLD = 70;
            const MIN_APPROVALS = 2;
            
            const quorumReached = danceSum >= QUORUM_THRESHOLD && approvals >= MIN_APPROVALS;
            const autoMergeReady = quorumReached && !safetyVeto && rejections === 0;
            
            core.setOutput('quorum_reached', quorumReached);
            core.setOutput('auto_merge_ready', autoMergeReady);
            core.setOutput('dance_sum', danceSum);
            core.setOutput('approvals', approvals);
            core.setOutput('safety_veto', safetyVeto);

      - name: Auto-merge if quorum reached
        if: steps.quorum.outputs.auto_merge_ready == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              merge_method: 'squash',
              commit_title: `Merge PR #${context.issue.number}: ${{ github.event.pull_request.title }}`,
            });
            
            core.info('✅ Auto-merged via Bee-Quorum consensus');

