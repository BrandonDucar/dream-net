name: dreamnet-ci-hardened
on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  security-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    
    steps:
      - name: ðŸ›¡ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for Gitleaks

      - name: ðŸ” Run Gitleaks (Secret Detection)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: false # Hard gate: fail if secrets found

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'pnpm'

      - name: ðŸš€ Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ðŸ› ï¸ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ Build
        run: pnpm run build --if-present

      - name: ðŸ©º Lint & Type Check
        run: |
          pnpm --if-present run lint
          pnpm --if-present run typecheck

      - name: ðŸ§ª Run Tests
        run: pnpm test --if-present

      - name: ðŸ“‘ Generate SBOM (Software Bill of Materials)
        uses: anchore/sbom-action@v0
        with:
          format: spdx-json
          output-file: dreamnet-sbom.spdx.json

      - name: ðŸ“¤ Upload SBOM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dreamnet-sbom
          path: dreamnet-sbom.spdx.json

  deploy-preview:
    needs: security-and-build
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ Deploy to Vercel (Preview)
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          alias-domains: |
            preview.dreamnet.live
        id: vercel-deploy

      - name: ðŸ§ª Post-Deploy Health Probe
        run: |
          set -euo pipefail
          # Check health endpoint exported by portal
          echo "Probing: ${{ steps.vercel-deploy.outputs.preview-url }}/health"
          curl -fsS "${{ steps.vercel-deploy.outputs.preview-url }}/health" > health.json
          
          # Validate OK status and SLO latency
          jq -e '.ok == true' health.json > /dev/null
          LATENCY=$(jq '.latency_ms' health.json)
          echo "Latency: ${LATENCY}ms (SLO: <= 500ms)"
          [ "$LATENCY" -le 500 ]
