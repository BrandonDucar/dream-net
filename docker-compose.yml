version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # THE NERVOUS SYSTEM (Redis / Nerve)
  # ---------------------------------------------------------------------------
  nerve:
    image: redis:alpine
    container_name: dreamnet_nerve
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - nerve_data:/data
    networks:
      - dream_network

  # ---------------------------------------------------------------------------
  # THE BRAIN (Control Core)
  # ---------------------------------------------------------------------------
    build:
      context: .
      dockerfile: packages/organs/endocrine/dreamnet-control-core/Dockerfile
    container_name: dreamnet_control_core
    restart: on-failure
    labels:
      - "dreamnet.role=sacred"      # PREDATOR PROTOCOL: DO NOT TOUCH
      - "dreamnet.protection=max"
    depends_on:
      - nerve
    environment:
      - NODE_ENV=development
      - REDIS_URL=redis://nerve:6379
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - PRIVATE_KEY=${PRIVATE_KEY}
      - HOT_SENDER_PK=${HOT_SENDER_PK}
    volumes:
      #- ./packages/dreamnet-control-core:/app
      #- /app/node_modules
      - passports_data:/root/.dreamnet/passports
    networks:
      - dream_network

  # ---------------------------------------------------------------------------
  # THE MUSCLE (WoolyAI - GPU Hypervisor)
  # ---------------------------------------------------------------------------
  wooly-ai:
    # UPDATED: 'client' was not found. Using 'controller' as the primary interface.
    image: woolyai/controller:latest
    container_name: dreamnet_wooly_ai
    restart: unless-stopped
    labels:
      - "dreamnet.role=worker"      # PREDATOR PROTOCOL: RESTART ON FAILURE
      - "dreamnet.protection=standard"
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]
    environment:
      # Controller manages the GPU pool
      - PORT=8080
    ports:
      - "8080:8080"
    volumes:
      - wooly_data:/data
    networks:
      - dream_network

  # ---------------------------------------------------------------------------
  # THE NEURAL INTERFACE (Portainer / Neurontainer Stand-in)
  # ---------------------------------------------------------------------------
  # NOTE: 'neurontainer' extension runs inside Docker Desktop itself.
  # This service provides a web UI for container management if needed.
  local-manager:
    image: portainer/portainer-ce:latest
    container_name: dreamnet_neurontainer_ui
    restart: always
    ports:
      - "9000:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - dream_network

  # ---------------------------------------------------------------------------
  # THE WEB SKIN (Crawl4AI - Sensory Ingestion)
  # ---------------------------------------------------------------------------
  web-skin:
    image: unclecode/crawl4ai:latest
    container_name: dreamnet_web_skin
    restart: unless-stopped
    labels:
      - "dreamnet.role=sensor"
      - "dreamnet.protection=standard"
    ports:
      - "11235:11235"
    environment:
      - CRAWL4AI_API_TOKEN=${CRAWL4AI_API_TOKEN:-dreamnet_secret_sensor}
    networks:
      - dream_network

  # ---------------------------------------------------------------------------
  # THE COMMAND INTERFACE (Moltbot / Clawdbot Gateway)
  # ---------------------------------------------------------------------------
  moltbot-gateway:
    image: moltbot:local
    container_name: dreamnet_moltbot_gateway
    restart: unless-stopped
    ports:
      - "11234:11234"
    volumes:
      - moltbot_data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - CLAWDBOT_GATEWAY_TOKEN=${MOLTBOT_TOKEN:-dreamnet_secret_cmd}
      - CLAWDBOT_GATEWAY_PORT=11234
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_ENABLED=true
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      - DISCORD_ENABLED=true
      - DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - CLAWDBOT_STATE_DIR=/app/data
    command: ["node", "dist/index.js", "gateway", "--bind", "all", "--port", "11234"]
    networks:
      - dream_network

  # ---------------------------------------------------------------------------
  # THE MEMORY FABRIC (Qdrant - Vector Mesh)
  # ---------------------------------------------------------------------------
  qdrant:
    image: qdrant/qdrant:latest
    container_name: dreamnet_qdrant
    restart: always
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - dream_network

volumes:
  nerve_data:
  passports_data:
  wooly_data:
  portainer_data:
  moltbot_data:
  qdrant_data:

networks:
  dream_network:
    driver: bridge
