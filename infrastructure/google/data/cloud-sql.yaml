apiVersion: sql.cnrm.cloud.google.com/v1beta1
kind: SQLInstance
metadata:
  name: dreamnet-postgres
  labels:
    app: dreamnet
    environment: production
spec:
  region: us-central1
  projectRef:
    external: aqueous-tube-470317-m6
  databaseVersion: POSTGRES_15
  settings:
    tier: db-f1-micro  # Free tier, upgrade to db-n1-standard-1 for production
    availabilityType: ZONAL
    diskType: PD_SSD
    diskSize: 20GB
    diskAutoresize: true
    backupConfiguration:
      enabled: true
      startTime: "03:00"
      pointInTimeRecoveryEnabled: true
    ipConfiguration:
      ipv4Enabled: true
      authorizedNetworks:
        - value: "0.0.0.0/0"  # Restrict in production
          name: "all"
      requireSsl: true
    databaseFlags:
      - name: max_connections
        value: "100"
    userLabels:
      app: dreamnet
      managed-by: dreamnet-infra
---
apiVersion: sql.cnrm.cloud.google.com/v1beta1
kind: SQLDatabase
metadata:
  name: dreamnet-db
spec:
  instanceRef:
    name: dreamnet-postgres
  charset: UTF8
  collation: en_US.UTF8
---
apiVersion: sql.cnrm.cloud.google.com/v1beta1
kind: SQLUser
metadata:
  name: dreamnet-user
spec:
  instanceRef:
    name: dreamnet-postgres
  password:
    valueFrom:
      secretKeyRef:
        name: dreamnet-secrets
        key: db-password
  type: BUILT_IN

